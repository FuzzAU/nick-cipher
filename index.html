<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nickâ€™s Caesar Code Dial</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: Canvas;
      color: CanvasText;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .card {
      width: min(980px, 100vw);
      padding: 18px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      margin: 12px;
      box-sizing: border-box;
    }

    h1 { margin: 0 0 10px; font-size: 22px; }
    .desc { margin: 0 0 14px; font-size: 15px; opacity: .92; line-height: 1.35; }

    .label { font-weight: 900; margin: 14px 0 8px; }

    .cipherline { display: flex; flex-wrap: wrap; gap: 6px; }

    .ch {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 22px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      user-select: none;
    }

    .ch.active {
      border-color: rgba(80,140,255,.9);
      box-shadow: 0 0 0 2px rgba(80,140,255,.25);
      background: rgba(80,140,255,.10);
    }

    .ch.good {
      border-color: rgba(60,200,120,.9);
      box-shadow: 0 0 0 2px rgba(60,200,120,.20);
      background: rgba(60,200,120,.10);
    }

    .box {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      background: rgba(127,127,127,.04);
    }

    .callouts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 12px;
    }
    @media (max-width: 640px) { .callouts { grid-template-columns: 1fr; } }

    .bigPill {
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.08);
      font-weight: 1000;
      font-size: 18px;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }
    .mono { font-family: ui-monospace, Menlo, Monaco, Consolas, monospace; }

    .bigValue {
      font-size: 28px;
      letter-spacing: 1px;
    }

    .map {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 16px;
      white-space: pre;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      overflow-x: auto;
      margin-bottom: 12px;
    }

    input[type="range"] { width: 100%; }

    .preview {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: 950;
    }

    .preview span {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 22px;
    }

    .btnRow {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.45);
      background: transparent;
      font-weight: 950;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled { opacity: .45; cursor: not-allowed; }

    .answer {
      margin-top: 14px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 28px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.06);
      letter-spacing: 1px;
      min-height: 44px;
    }

    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      font-size: 14px;
      min-height: 20px;
    }

    .msg.ok { border-color: rgba(60,200,120,.6); background: rgba(60,200,120,.10); }
    .msg.bad { border-color: rgba(255,90,90,.6); background: rgba(255,90,90,.10); }

    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <h1>Decode the Nintendo Store Code ðŸŽ®</h1>
    <p class="desc">
      This is a <b>Caesar cipher</b> (a letter-shifting code). Start at the highlighted character.
      The highlighted digit in the key is how many letters to shift forward.
      Use the dial to set the <b>rotation</b>, then press <b>Add</b>.
      If itâ€™s tricky, grab Dad to help you.
    </p>

    <div class="label">Encrypted text</div>
    <div class="cipherline" id="cipherLine"></div>

    <div class="label">Rotation key</div>
    <div class="cipherline" id="keyLine"></div>

    <div class="box">
      <div class="callouts">
        <div class="bigPill">
          <div>Key digit</div>
          <div class="mono bigValue" id="keyDigitBig">0</div>
        </div>
        <div class="bigPill">
          <div>Rotation</div>
          <div class="mono bigValue"><span id="rotNow">0</span></div>
        </div>
      </div>

      <div class="map" id="alphaMap"></div>

      <input id="dial" type="range" min="0" max="25" step="1" value="0" />

      <div class="preview">
        <div>Preview</div>
        <span id="previewChar">?</span>
      </div>

      <div class="btnRow">
        <button id="addBtn">Add</button>
        <button id="backBtn">Back</button>
        <button id="startOverBtn">Start over</button>
      </div>

      <div class="answer" id="answerBox"></div>
      <div class="msg" id="msgBox"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const CIPHER = "B1AR5DY26W5U6UGJ";
  const KEY    = "3025068001070983";
  const TARGET = "E1CW5JG26X5B6DOM";
  const ALPH = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const A = "A".charCodeAt(0);

  const cipherLine = document.getElementById("cipherLine");
  const keyLine = document.getElementById("keyLine");
  const alphaMap = document.getElementById("alphaMap");

  const dial = document.getElementById("dial");
  const rotNow = document.getElementById("rotNow");
  const keyDigitBig = document.getElementById("keyDigitBig");
  const previewChar = document.getElementById("previewChar");

  const addBtn = document.getElementById("addBtn");
  const backBtn = document.getElementById("backBtn");
  const startOverBtn = document.getElementById("startOverBtn");
  const answerBox = document.getElementById("answerBox");
  const msgBox = document.getElementById("msgBox");

  const cipherSpans = [], keySpans = [];

  function mkSpan(ch) {
    const s = document.createElement("span");
    s.className = "ch";
    s.textContent = ch;
    return s;
  }

  [...CIPHER].forEach(c => { const s = mkSpan(c); cipherLine.appendChild(s); cipherSpans.push(s); });
  [...KEY].forEach(k => { const s = mkSpan(k); keyLine.appendChild(s); keySpans.push(s); });

  let pos = 0, answer = [];

  const isUpper = c => c >= "A" && c <= "Z";
  const isDigit = c => c >= "0" && c <= "9";
  const shift = (c, n) => String.fromCharCode(A + ((c.charCodeAt(0) - A + n) % 26));

  function renderMap(rot, c) {
    const base = ALPH;
    const moved = base.slice(rot) + base.slice(0, rot);
    let mark = "";
    if (isUpper(c)) mark = " ".repeat(c.charCodeAt(0) - A) + "â–²";
    alphaMap.textContent =
      `Normal: ${base}\n` +
      `Shift : ${moved}\n` +
      (mark ? `        ${mark}` : "");
  }

  function setMsg(text, kind) {
    msgBox.textContent = text || "";
    msgBox.className = "msg" + (kind ? " " + kind : "");
  }

  function updatePreview() {
    const c = CIPHER[pos];
    if (!c) return;

    const r = Number(dial.value);
    rotNow.textContent = String(r);

    if (isDigit(c)) {
      previewChar.textContent = c;
    } else if (isUpper(c)) {
      previewChar.textContent = shift(c, r);
    } else {
      previewChar.textContent = c;
    }

    renderMap(r, c);
  }

  function updateUI() {
    cipherSpans.forEach((s, i) => {
      s.classList.toggle("active", i === pos);
      s.classList.toggle("good", i < answer.length);
    });
    keySpans.forEach((s, i) => s.classList.toggle("active", i === pos));

    const c = CIPHER[pos] || "";
    const k = KEY[pos] || "0";
    keyDigitBig.textContent = c ? k : "âœ“";

    dial.disabled = !c || isDigit(c);
    addBtn.disabled = !c;
    backBtn.disabled = !answer.length;

    answerBox.textContent = answer.join("");
    updatePreview();
  }

  function addCurrent() {
    const c = CIPHER[pos];
    if (!c) return;

    let picked;
    if (isDigit(c)) picked = c;
    else if (isUpper(c)) picked = shift(c, Number(dial.value));
    else picked = c;

    if (picked !== TARGET[pos]) {
      setMsg("Not quite â€” try another rotation number.", "bad");
      return;
    }

    answer.push(picked);
    pos++;
    dial.value = 0;
    setMsg("Correct! âœ…", "ok");

    if (pos === CIPHER.length) {
      setMsg("Unlocked! ðŸŽ‰", "ok");
      launchConfetti();
    }

    updateUI();
  }

  function back() {
    if (!answer.length) return;
    answer.pop();
    pos = Math.max(0, pos - 1);
    dial.value = 0;
    setMsg("", "");
    updateUI();
  }

  function startOver() {
    pos = 0;
    answer = [];
    dial.value = 0;
    setMsg("", "");
    updateUI();
  }

  dial.addEventListener("input", () => { setMsg("", ""); updatePreview(); });
  addBtn.addEventListener("click", addCurrent);
  backBtn.addEventListener("click", back);
  startOverBtn.addEventListener("click", startOver);

  // ---- Confetti ----
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");

  function resize() {
    const d = window.devicePixelRatio || 1;
    canvas.width = innerWidth * d;
    canvas.height = innerHeight * d;
    canvas.style.width = innerWidth + "px";
    canvas.style.height = innerHeight + "px";
    ctx.setTransform(d, 0, 0, d, 0, 0);
  }
  window.addEventListener("resize", resize);

  function launchConfetti() {
    resize();
    canvas.style.display = "block";

    const pieces = Array.from({ length: 220 }, () => ({
      x: Math.random() * innerWidth,
      y: -20 - Math.random() * 220,
      vx: (Math.random() - 0.5) * 3,
      vy: 2 + Math.random() * 5,
      s: 4 + Math.random() * 6,
      r: Math.random() * Math.PI,
      vr: (Math.random() - 0.5) * 0.2
    }));

    let t = 0;
    (function frame() {
      ctx.clearRect(0, 0, innerWidth, innerHeight);
      for (const p of pieces) {
        p.x += p.vx; p.y += p.vy; p.vy += 0.02; p.r += p.vr;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.r);
        ctx.fillStyle = `hsl(${(p.x + t) % 360}, 90%, 60%)`;
        ctx.fillRect(-p.s / 2, -p.s / 2, p.s, p.s);
        ctx.restore();
      }
      if (t++ < 160) requestAnimationFrame(frame);
      else canvas.style.display = "none";
    })();
  }

  updateUI();
})();
</script>
</body>
</html>
