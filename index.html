<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nickâ€™s Code Dial</title>

  <!-- iPad â€œadd to home screenâ€ / full-screen web app hints -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: Canvas;
      color: CanvasText;
    }

    /* Full-screen friendly layout */
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .card {
      width: min(980px, 100vw);
      padding: 18px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      box-sizing: border-box;
      margin: 12px;
    }

    h1 { margin: 0 0 10px; font-size: 22px; }
    .desc {
      margin: 0 0 14px;
      font-size: 15px;
      opacity: .9;
      line-height: 1.35;
    }

    .label { font-weight: 900; margin: 14px 0 8px; }

    .cipherline { display: flex; flex-wrap: wrap; gap: 6px; }

    .ch {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 22px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      user-select: none;
    }
    .ch.active {
      border-color: rgba(80,140,255,.9);
      box-shadow: 0 0 0 2px rgba(80,140,255,.25);
      background: rgba(80,140,255,.10);
    }
    .ch.good {
      border-color: rgba(60,200,120,.9);
      box-shadow: 0 0 0 2px rgba(60,200,120,.20);
      background: rgba(60,200,120,.10);
    }

    .dialBox {
      margin-top: 18px;
      padding: 18px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
    }

    .dialHeader {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      margin-bottom: 10px;
      font-weight: 950;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .bigRow {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .bigRow .pill {
      display: inline-block;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.08);
      font-weight: 950;
      font-size: 16px;
    }

    input[type="range"] { width: 100%; }

    .selected {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-top: 10px;
      font-size: 18px;
      font-weight: 900;
    }

    .btnRow {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      cursor: pointer;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.45);
      background: transparent;
      font-weight: 950;
      font-size: 16px;
    }
    button:disabled { opacity: .45; cursor: not-allowed; }

    .answer {
      margin-top: 14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 28px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.06);
      letter-spacing: 1px;
      min-height: 44px;
    }

    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      font-size: 14px;
      min-height: 20px;
    }
    .msg.ok { border-color: rgba(60,200,120,.6); background: rgba(60,200,120,.10); }
    .msg.bad { border-color: rgba(255,90,90,.6); background: rgba(255,90,90,.10); }

    /* Confetti canvas sits on top when needed */
    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <h1>Decode the Nintendo Store Code ðŸŽ®</h1>
    <p class="desc">
      Start at the highlighted character. Look at the highlighted key digit underneath it.
      For letters: move forward in the alphabet by that many steps, then use the dial to pick the decoded letter and press <b>Add</b>.
      For numbers: just press <b>Add</b>.
    </p>

    <div class="label">Encrypted text</div>
    <div class="cipherline" id="cipherLine"></div>

    <div class="label">Rotation key</div>
    <div class="cipherline" id="keyLine"></div>

    <div class="dialBox">
      <div class="dialHeader">
        <div>Dial</div>
        <div class="mono">Step: <span id="stepNow">1</span>/<span id="stepTotal">16</span></div>
      </div>

      <div class="bigRow">
        <div class="pill mono">Cipher: <span id="cipherNow">?</span> &nbsp; | &nbsp; Key: <span id="keyNow">?</span></div>
      </div>

      <!-- IMPORTANT FIX:
           The dial now selects the *decoded letter* (Aâ€“Z), not a â€œrotation numberâ€.
           This matches how kids naturally use a dial: â€œIâ€™m choosing the letter I think it becomes.â€
      -->
      <input id="dial" type="range" min="0" max="25" step="1" value="0" />

      <div class="selected">
        <div>Selected:</div>
        <div class="mono" style="font-size: 22px;"><span id="selectedLetter">A</span></div>
      </div>

      <div class="btnRow">
        <button id="addBtn">Add</button>
        <button id="backBtn">Back</button>
        <button id="startOverBtn">Start over</button>
      </div>

      <div class="answer" id="answerBox"></div>
      <div class="msg" id="msgBox"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const CIPHER = "B1AR5DY26W5U6UGJ";
  const KEY    = "3025068001070983";
  const TARGET = "E1CW5JG26X5B6DOM";

  const ALPH = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";

  const cipherLine = document.getElementById("cipherLine");
  const keyLine = document.getElementById("keyLine");

  const dial = document.getElementById("dial");
  const selectedLetter = document.getElementById("selectedLetter");

  const addBtn = document.getElementById("addBtn");
  const backBtn = document.getElementById("backBtn");
  const startOverBtn = document.getElementById("startOverBtn");

  const answerBox = document.getElementById("answerBox");
  const msgBox = document.getElementById("msgBox");

  const stepNow = document.getElementById("stepNow");
  const stepTotal = document.getElementById("stepTotal");
  const cipherNow = document.getElementById("cipherNow");
  const keyNow = document.getElementById("keyNow");

  const cipherSpans = [];
  const keySpans = [];

  function mkSpan(ch) {
    const s = document.createElement("span");
    s.className = "ch";
    s.textContent = ch;
    return s;
  }

  for (let i = 0; i < CIPHER.length; i++) {
    const s = mkSpan(CIPHER[i]);
    cipherLine.appendChild(s);
    cipherSpans.push(s);
  }

  for (let i = 0; i < KEY.length; i++) {
    const s = mkSpan(KEY[i]);
    keyLine.appendChild(s);
    keySpans.push(s);
  }

  let pos = 0;
  let answer = [];

  function isUpper(ch) {
    const code = ch.charCodeAt(0);
    return code >= 65 && code <= 90;
  }
  function isDigit(ch) {
    return ch >= "0" && ch <= "9";
  }

  function setMsg(text, cls) {
    msgBox.textContent = text || "";
    msgBox.className = "msg" + (cls ? " " + cls : "");
  }

  function updateSelected() {
    selectedLetter.textContent = ALPH[Number(dial.value)] || "A";
  }

  function updateUI() {
    stepTotal.textContent = String(CIPHER.length);
    stepNow.textContent = String(Math.min(pos + 1, CIPHER.length));

    cipherSpans.forEach((s, i) => {
      s.classList.toggle("active", i === pos);
      s.classList.toggle("good", i < answer.length);
    });
    keySpans.forEach((s, i) => s.classList.toggle("active", i === pos));

    const done = pos >= CIPHER.length;
    const c = CIPHER[pos] ?? "";
    const k = KEY[pos] ?? "";

    cipherNow.textContent = done ? "âœ“" : c;
    keyNow.textContent = done ? "âœ“" : k;

    // Dial rules:
    // - for digits: disable dial (they don't change)
    // - for letters: dial selects a letter (Aâ€“Z)
    dial.disabled = done || isDigit(c);

    addBtn.disabled = done;
    backBtn.disabled = answer.length === 0;

    answerBox.textContent = answer.join("");
    updateSelected();
  }

  function addCurrent() {
    if (pos >= CIPHER.length) return;

    const c = CIPHER[pos];
    const expected = TARGET[pos];

    let picked;

    if (isDigit(c)) {
      picked = c; // numbers pass through
    } else if (isUpper(c)) {
      // FIXED: dial selects the letter Nick thinks it becomes
      picked = ALPH[Number(dial.value)];
    } else {
      picked = c;
    }

    if (picked !== expected) {
      setMsg("Not quite â€” try another letter on the dial.", "bad");
      return;
    }

    answer.push(picked);
    pos++;
    dial.value = "0";
    setMsg("Correct! âœ…", "ok");

    if (pos >= CIPHER.length) {
      setMsg("Unlocked! ðŸŽ‰", "ok");
      launchConfetti();
    }

    updateUI();
  }

  function back() {
    if (!answer.length) return;
    answer.pop();
    pos = Math.max(0, pos - 1);
    dial.value = "0";
    setMsg("", "");
    updateUI();
  }

  function startOver() {
    pos = 0;
    answer = [];
    dial.value = "0";
    setMsg("", "");
    updateUI();
  }

  dial.addEventListener("input", () => { setMsg("", ""); updateSelected(); });
  addBtn.addEventListener("click", addCurrent);
  backBtn.addEventListener("click", back);
  startOverBtn.addEventListener("click", startOver);

  // ---------- Confetti ----------
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    canvas.width = Math.floor(window.innerWidth * dpr);
    canvas.height = Math.floor(window.innerHeight * dpr);
    canvas.style.width = window.innerWidth + "px";
    canvas.style.height = window.innerHeight + "px";
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  window.addEventListener("resize", resizeCanvas);

  function launchConfetti() {
    resizeCanvas();
    canvas.style.display = "block";

    const pieces = [];
    const W = window.innerWidth, H = window.innerHeight;
    const count = Math.min(220, Math.floor(W / 5));

    for (let i = 0; i < count; i++) {
      pieces.push({
        x: Math.random() * W,
        y: -20 - Math.random() * H * 0.2,
        vx: (Math.random() - 0.5) * 3,
        vy: 2 + Math.random() * 5,
        size: 4 + Math.random() * 6,
        rot: Math.random() * Math.PI,
        vr: (Math.random() - 0.5) * 0.2,
        life: 140 + Math.random() * 90
      });
    }

    let t = 0;
    function frame() {
      t++;
      ctx.clearRect(0, 0, W, H);

      for (const p of pieces) {
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.vy += 0.02; // gentle gravity
        p.life -= 1;

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);

        // No fixed colors requested; use random per draw
        ctx.fillStyle = `hsl(${Math.floor((p.x + t) % 360)}, 90%, 60%)`;
        ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size);

        ctx.restore();
      }

      // stop after ~2.5 seconds
      if (t < 160 && pieces.some(p => p.life > 0 && p.y < H + 40)) {
        requestAnimationFrame(frame);
      } else {
        canvas.style.display = "none";
        ctx.clearRect(0, 0, W, H);
      }
    }
    requestAnimationFrame(frame);
  }

  // Init
  updateUI();
})();
</script>
</body>
</html>
