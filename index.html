<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Nickâ€™s Code Dial</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0b">

  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: Canvas;
      color: CanvasText;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    .card {
      width: min(980px, 100vw);
      padding: 18px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      margin: 12px;
      box-sizing: border-box;
    }

    h1 { margin: 0 0 10px; font-size: 22px; }
    .desc { margin: 0 0 14px; font-size: 15px; opacity: .92; }

    .label { font-weight: 900; margin: 14px 0 8px; }

    .cipherline {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .ch {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 22px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      user-select: none;
    }

    .ch.active {
      border-color: rgba(80,140,255,.9);
      box-shadow: 0 0 0 2px rgba(80,140,255,.25);
      background: rgba(80,140,255,.10);
    }

    .ch.good {
      border-color: rgba(60,200,120,.9);
      box-shadow: 0 0 0 2px rgba(60,200,120,.20);
      background: rgba(60,200,120,.10);
    }

    .box {
      margin-top: 16px;
      padding: 16px;
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      background: rgba(127,127,127,.04);
    }

    .topStats {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      font-weight: 950;
      margin-bottom: 10px;
    }

    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.08);
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
    }

    .map {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 16px;
      white-space: pre;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      overflow-x: auto;
      margin-bottom: 12px;
    }

    input[type="range"] { width: 100%; }

    .preview {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: 950;
    }

    .preview span {
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 22px;
    }

    .btnRow {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    button {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.45);
      background: transparent;
      font-weight: 950;
      font-size: 16px;
      cursor: pointer;
    }

    button:disabled { opacity: .45; cursor: not-allowed; }

    .answer {
      margin-top: 14px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, monospace;
      font-size: 28px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(127,127,127,.35);
      background: rgba(127,127,127,.06);
      letter-spacing: 1px;
      min-height: 44px;
    }

    .msg {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.25);
      background: rgba(127,127,127,.06);
      font-size: 14px;
      min-height: 20px;
    }

    .msg.ok { border-color: rgba(60,200,120,.6); background: rgba(60,200,120,.10); }
    .msg.bad { border-color: rgba(255,90,90,.6); background: rgba(255,90,90,.10); }

    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: none;
      z-index: 9999;
    }
  </style>
</head>
<body>
<canvas id="confetti"></canvas>

<div class="wrap">
  <div class="card">
    <h1>Decode the Nintendo Store Code ðŸŽ®</h1>
    <p class="desc">
      Work left to right. Use the highlighted key digit as the rotation number.
      Slide the dial until the alphabet lines up, then press <b>Add</b>.
    </p>

    <div class="label">Encrypted text</div>
    <div class="cipherline" id="cipherLine"></div>

    <div class="label">Rotation key</div>
    <div class="cipherline" id="keyLine"></div>

    <div class="box">
      <div class="topStats">
        <span class="pill">Step <span id="stepNow">1</span>/<span id="stepTotal">16</span></span>
        <span class="pill">Cipher: <span id="cipherNow">?</span></span>
        <span class="pill">Key: <span id="keyNow">?</span></span>
        <span class="pill">Rotation: <span id="rotNow">0</span></span>
      </div>

      <div class="map" id="alphaMap"></div>

      <input id="dial" type="range" min="0" max="25" step="1" value="0" />

      <div class="preview">
        <div>Preview</div>
        <span id="previewChar">?</span>
      </div>

      <div class="btnRow">
        <button id="addBtn">Add</button>
        <button id="backBtn">Back</button>
        <button id="startOverBtn">Start over</button>
      </div>

      <div class="answer" id="answerBox"></div>
      <div class="msg" id="msgBox"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const CIPHER = "B1AR5DY26W5U6UGJ";
  const KEY    = "3025068001070983";
  const TARGET = "E1CW5JG26X5B6DOM";
  const ALPH = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const A = "A".charCodeAt(0);

  const cipherLine = document.getElementById("cipherLine");
  const keyLine = document.getElementById("keyLine");
  const alphaMap = document.getElementById("alphaMap");
  const dial = document.getElementById("dial");
  const rotNow = document.getElementById("rotNow");
  const previewChar = document.getElementById("previewChar");
  const addBtn = document.getElementById("addBtn");
  const backBtn = document.getElementById("backBtn");
  const startOverBtn = document.getElementById("startOverBtn");
  const answerBox = document.getElementById("answerBox");
  const msgBox = document.getElementById("msgBox");
  const stepNow = document.getElementById("stepNow");
  const stepTotal = document.getElementById("stepTotal");
  const cipherNow = document.getElementById("cipherNow");
  const keyNow = document.getElementById("keyNow");

  const cipherSpans = [], keySpans = [];

  function mkSpan(ch) {
    const s = document.createElement("span");
    s.className = "ch";
    s.textContent = ch;
    return s;
  }

  [...CIPHER].forEach(c => { const s = mkSpan(c); cipherLine.appendChild(s); cipherSpans.push(s); });
  [...KEY].forEach(k => { const s = mkSpan(k); keyLine.appendChild(s); keySpans.push(s); });

  let pos = 0, answer = [];

  const isUpper = c => c >= "A" && c <= "Z";
  const isDigit = c => c >= "0" && c <= "9";
  const shift = (c, n) => String.fromCharCode(A + ((c.charCodeAt(0) - A + n) % 26));

  function renderMap(rot, c) {
    const base = ALPH;
    const moved = base.slice(rot) + base.slice(0, rot);
    let mark = "";
    if (isUpper(c)) mark = " ".repeat(c.charCodeAt(0) - A) + "â–²";
    alphaMap.textContent = `Normal: ${base}\nShift : ${moved}\n${mark ? "        " + mark : ""}`;
  }

  function updatePreview() {
    const c = CIPHER[pos];
    if (!c) return;
    const r = Number(dial.value);
    rotNow.textContent = r;
    previewChar.textContent = isDigit(c) ? c : shift(c, r);
    renderMap(r, c);
  }

  function updateUI() {
    stepTotal.textContent = CIPHER.length;
    stepNow.textContent = Math.min(pos + 1, CIPHER.length);
    cipherSpans.forEach((s, i) => { s.classList.toggle("active", i === pos); s.classList.toggle("good", i < answer.length); });
    keySpans.forEach((s, i) => s.classList.toggle("active", i === pos));

    const c = CIPHER[pos] || "";
    cipherNow.textContent = c || "âœ“";
    keyNow.textContent = KEY[pos] || "âœ“";

    dial.disabled = !c || isDigit(c);
    addBtn.disabled = !c;
    backBtn.disabled = !answer.length;

    answerBox.textContent = answer.join("");
    updatePreview();
  }

  function addCurrent() {
    const c = CIPHER[pos];
    if (!c) return;
    const picked = isDigit(c) ? c : shift(c, Number(dial.value));
    if (picked !== TARGET[pos]) {
      msgBox.textContent = "Not quite â€” try another rotation.";
      msgBox.className = "msg bad";
      return;
    }
    msgBox.textContent = "Correct! âœ…";
    msgBox.className = "msg ok";
    answer.push(picked);
    pos++;
    dial.value = 0;
    if (pos === CIPHER.length) { msgBox.textContent = "Unlocked! ðŸŽ‰"; msgBox.className = "msg ok"; launchConfetti(); }
    updateUI();
  }

  function back() { if (!answer.length) return; answer.pop(); pos--; dial.value = 0; msgBox.textContent = ""; updateUI(); }
  function startOver() { pos = 0; answer = []; dial.value = 0; msgBox.textContent = ""; updateUI(); }

  dial.addEventListener("input", updatePreview);
  addBtn.addEventListener("click", addCurrent);
  backBtn.addEventListener("click", back);
  startOverBtn.addEventListener("click", startOver);

  /* Confetti (unchanged) */
  const canvas = document.getElementById("confetti");
  const ctx = canvas.getContext("2d");
  function resize() {
    const d = window.devicePixelRatio || 1;
    canvas.width = innerWidth * d; canvas.height = innerHeight * d;
    canvas.style.width = innerWidth + "px"; canvas.style.height = innerHeight + "px";
    ctx.setTransform(d,0,0,d,0,0);
  }
  function launchConfetti() {
    resize(); canvas.style.display = "block";
    const pieces = Array.from({length:220},()=>({
      x:Math.random()*innerWidth,y:-20-Math.random()*200,
      vx:(Math.random()-.5)*3,vy:2+Math.random()*5,
      s:4+Math.random()*6,r:Math.random()*Math.PI,vr:(Math.random()-.5)*.2
    }));
    let t=0;
    (function frame(){
      ctx.clearRect(0,0,innerWidth,innerHeight);
      pieces.forEach(p=>{
        p.x+=p.vx; p.y+=p.vy; p.vy+=.02; p.r+=p.vr;
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.r);
        ctx.fillStyle=`hsl(${(p.x+t)%360},90%,60%)`;
        ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s); ctx.restore();
      });
      if(t++<160) requestAnimationFrame(frame);
      else canvas.style.display="none";
    })();
  }

  updateUI();
})();
</script>
</body>
</html>
